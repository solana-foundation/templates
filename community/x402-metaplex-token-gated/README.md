# Token-Gated Membership DApp

A Next.js 15 educational template demonstrating token-gated content using Solana NFTs. This application showcases how to build membership tiers backed by NFTs with expiration tracking, renewals, and payment integration.

## Overview

This project implements a three-tier membership system (Bronze, Silver, Gold) where access is controlled through Metaplex Core NFTs on Solana. Each NFT contains expiration metadata, enabling time-limited memberships that can be renewed or upgraded.

### Key Features

- **Wallet Authentication**: Sign-in with Solana wallets using message signing (no transactions required for auth)
- **NFT-Based Access Control**: Membership verification through on-chain NFT ownership
- **Expiration System**: Time-limited memberships with grace periods
- **Renewal Flow**: Extend existing memberships while preserving remaining time
- **Payment Integration**: x402 payment middleware for tier purchases
- **Server-Side Verification**: NFT ownership verified via Helius DAS API
- **Type-Safe**: Full TypeScript implementation with strict typing

## Architecture

### Tech Stack

- **Framework**: Next.js 15 (App Router, Server Components, Middleware)
- **Blockchain**: Solana (Devnet)
- **NFT Standard**: Metaplex Core with custom attributes plugin
- **Wallet**: @wallet-ui/react with Wallet Standard support
- **Styling**: Tailwind CSS + shadcn/ui
- **Payment**: x402-next middleware
- **API**: Helius Digital Asset Standard (DAS) API

### Authentication Flow

1. User connects wallet via Wallet Standard
2. Client generates message with tier and timestamp
3. Wallet signs message with Ed25519 private key
4. Client sends signed message to API
5. Server verifies signature matches wallet's public key
6. Server mints/renews NFT to user's address

No blockchain transactions are required for authentication - signature verification happens off-chain using tweetnacl.

### NFT Metadata Structure

NFTs use Metaplex Core's Attributes plugin to store membership data:

```typescript
{
  tier: 'bronze' | 'silver' | 'gold',
  issued_at: '1699564800000',      // Unix timestamp (ms)
  expires_at: '1702243200000',     // Unix timestamp (ms)
  renewed_at?: '1701038400000',    // Optional: last renewal timestamp
  renewable: 'true'
}
```

## Prerequisites

- Node.js 18+
- pnpm (recommended) or npm
- Solana wallet with devnet SOL
- Helius API key (free tier sufficient)

## Setup

### 1. Install Dependencies

```bash
pnpm install
```

### 2. Environment Configuration

Create `.env.local` in the project root:

```bash
# Solana RPC endpoint
SOLANA_RPC_URL=https://api.devnet.solana.com

# Authority wallet private key (base58 or JSON array format)
AUTHORITY_PRIVATE_KEY=your_private_key_here

# Helius API for NFT verification
HELIUS_API_KEY=your_helius_api_key
HELIUS_NETWORK=devnet

# Collection addresses (generated by create-collections script)
NEXT_PUBLIC_BRONZE_COLLECTION=
NEXT_PUBLIC_SILVER_COLLECTION=
NEXT_PUBLIC_GOLD_COLLECTION=

# Payment recipient address
NEXT_PUBLIC_PAYMENT_ADDRESS=your_payment_address
```

### 3. Create Collections

Run the collection creation script to generate tier collections:

```bash
pnpm create-collections
```

This will output three collection addresses. Add them to your `.env.local` as shown above.

**Note:** The script uses your `AUTHORITY_PRIVATE_KEY` and `SOLANA_RPC_URL` from `.env.local` to create three Metaplex Core collections (one per tier).

### 4. Start Development Server

```bash
pnpm dev
```

The application will be available at `http://localhost:3000`.

## Project Structure

```
src/
├── app/
│   ├── api/nft/              # NFT operations
│   │   ├── mint/             # POST: Mint new membership NFT
│   │   ├── renew/            # POST: Extend NFT expiration
│   │   └── verify/           # GET/POST: Check NFT ownership
│   ├── buy/[tier]/           # Purchase flow (payment-protected)
│   ├── members/[tier]/       # Token-gated content
│   ├── renew/[tier]/         # Renewal flow (payment-protected)
│   └── page.tsx              # Public landing page
├── components/
│   ├── solana/               # Wallet utilities
│   │   ├── use-solana.tsx    # Main wallet hook
│   │   └── features.ts       # Wallet Standard feature extraction
│   ├── ui/                   # shadcn/ui components
│   ├── tier-content.tsx      # Mint UI logic
│   ├── renew-content.tsx     # Renewal UI logic
│   └── member-content.tsx    # Protected content display
├── hooks/
│   └── use-nft-verification.ts  # NFT ownership verification hook
├── lib/
│   ├── config.ts             # Tier configuration & constants
│   ├── types.ts              # TypeScript type definitions
│   ├── solana-auth.ts        # Message signing/verification
│   ├── mint-nft.ts           # NFT minting logic
│   ├── update-nft.ts         # NFT renewal logic
│   ├── verify-nft.ts         # NFT verification via Helius
│   └── utils.ts              # Helper functions
├── middleware.ts             # Payment protection & routing
└── scripts/
    └── create-collections.ts # One-time collection setup
```

## Core Concepts

### Membership Tiers

Tiers are configured in `src/lib/config.ts`:

- **Bronze**: 30 days, $0.01
- **Silver**: 60 days, $0.02
- **Gold**: 90 days, $0.03

Each tier has a dedicated Metaplex Core collection. Users can hold NFTs from multiple tiers simultaneously.

### Expiration Logic

```typescript
isExpired = currentTime > expiresAt
isExpiringSoon = daysUntilExpiration <= 7
gracePeriodActive = isExpired && (currentTime - expiresAt) <= 7 days
```

During the grace period, expired NFTs still grant access but show warnings.

### Renewal Behavior

When renewing before expiration, the new expiration extends from the current expiration date (not current time). This preserves remaining membership time.

```typescript
// If membership expires Jan 30 and renewed on Jan 15:
// Bronze (30 days): new expiration = Jan 30 + 30 days = Mar 1
```

### Message Signing

Authentication messages follow this format:

```typescript
// Minting: "Claim bronze NFT membership at 1699564800000"
// Renewal: "Renew bronze NFT abc123... at 1699564800000"
```

The timestamp prevents replay attacks (messages expire after 60 seconds by default).

## API Reference

### POST /api/nft/mint

Mint a new membership NFT.

**Request:**

```json
{
  "tier": "bronze",
  "walletAddress": "abc123...",
  "signature": "base58_encoded_signature",
  "message": "Claim bronze NFT membership at 1699564800000"
}
```

**Response:**

```json
{
  "success": true,
  "assetId": "nft_address",
  "expiresAt": 1702243200000,
  "explorerUrl": "https://explorer.solana.com/address/..."
}
```

### POST /api/nft/renew

Extend an existing NFT's expiration.

**Request:**

```json
{
  "tier": "bronze",
  "assetId": "nft_address",
  "walletAddress": "abc123...",
  "signature": "base58_encoded_signature",
  "message": "Renew bronze NFT abc123... at 1699564800000"
}
```

**Response:**

```json
{
  "success": true,
  "assetId": "nft_address",
  "expiresAt": 1704835200000,
  "explorerUrl": "https://explorer.solana.com/address/..."
}
```

### GET /api/nft/verify

Verify wallet's NFT ownership.

**Query Parameters:**

- `wallet`: Solana wallet address

**Response:**

```json
{
  "walletAddress": "abc123...",
  "hasAccess": true,
  "nfts": [
    {
      "assetId": "nft_address",
      "tier": "bronze",
      "expiresAt": 1702243200000,
      "isExpired": false,
      "isExpiringSoon": false,
      "gracePeriodActive": false,
      "daysUntilExpiration": 15,
      "expirationDate": "December 10, 2024",
      "explorerUrl": "https://explorer.solana.com/address/..."
    }
  ],
  "activeTiers": ["bronze"],
  "expiredTiers": []
}
```

## Custom Hooks

### useSolana()

Wrapper around @wallet-ui/react with Solana-specific utilities.

```typescript
const {
  account, // Connected wallet account
  wallet, // Wallet instance
  connected, // Connection status
  connect, // Connect wallet
  disconnect, // Disconnect wallet
  client, // Gill client
  signMessage, // Sign arbitrary message
  mintNFT, // Mint membership NFT
  renewNFT, // Renew membership NFT
} = useSolana()
```

### useNFTVerification(walletAddress, tier?)

Verify NFT ownership and track membership status.

```typescript
const {
  checking, // Loading state
  nfts, // All NFTs owned by wallet
  error, // Error message
  membership, // Tier-specific membership status
  hasAnyActive, // Has any active membership
  getMembershipStatus, // Get status for specific tier
  refetch, // Manually refresh verification
} = useNFTVerification(account?.address, 'bronze')
```

## Middleware

The middleware (`src/middleware.ts`) protects payment routes and enforces access control:

- `/buy/:tier` - Requires x402 payment before access
- `/renew/:tier` - Requires x402 payment before access
- `/members/:tier` - Redirects to purchase if no valid NFT

Payment tracking uses cookies in development. For production, implement database-backed payment records.

## Development

### Type Safety

All API endpoints and components are fully typed. Key types are defined in `src/lib/types.ts`:

```typescript
type TierType = 'bronze' | 'silver' | 'gold'

interface NFTWithExpiration {
  tier: TierType
  assetId: string
  expiresAt: number
  isExpired: boolean
  isExpiringSoon: boolean
  gracePeriodActive: boolean
  issuedAt?: number
  renewedAt?: number
}
```

### Adding a New Tier

1. Update `TIER_INFO` in `src/lib/config.ts`
2. Add environment variable for collection address
3. Update `TierType` union in `src/lib/types.ts`
4. Run collection creation script for new tier

### Customizing Expiration Periods

Edit `EXPIRATION_PERIODS` in `src/lib/config.ts`:

```typescript
export const EXPIRATION_PERIODS = {
  bronze: 30 * MILLISECONDS_PER_DAY,
  silver: 60 * MILLISECONDS_PER_DAY,
  gold: 90 * MILLISECONDS_PER_DAY,
} as const
```

### Testing on Devnet

1. Get devnet SOL from faucet: https://faucet.solana.com
2. Fund your authority wallet
3. Use Phantom/Solflare wallets in devnet mode
4. View transactions on Solana Explorer (devnet)

## Security Considerations

This is an educational template. For production use, consider:

- Implement message expiry validation in API routes
- Add rate limiting to prevent abuse
- Use database-backed payment verification
- Implement proper error logging and monitoring
- Add CSRF protection
- Validate all user inputs with schema validation (e.g., Zod)
- Secure private key storage (use secret management services)
- Implement proper session management
- Add comprehensive error boundaries

## Common Issues

### "Missing required environment variable"

Restart your development server after modifying `.env.local`. Next.js only loads environment variables at startup.

### "Wallet does not support message signing"

Ensure your wallet supports the Wallet Standard `solana:signMessage` feature. Phantom and Solflare both support this.

### NFT not showing after mint

Wait a few seconds for blockchain confirmation, then refresh. The Helius API may take time to index new assets.

### Signature verification fails

Check that:

- Message hasn't been modified between signing and verification
- Timestamp in message is recent (< 60 seconds)
- Base58 encoding/decoding is correct

## License

MIT

## Contributing

This is an educational template. Feel free to fork and adapt for your needs. Pull requests for improvements are welcome.
